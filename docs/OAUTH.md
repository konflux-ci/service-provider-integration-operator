# Service Provider Integration OAuth Service

OAuth2 protocol is the most commonly used way that allows users to authorize applications to communicate with service providers.
`spi-oauth` to use this protocol to obtain service provider’s access tokens without the need for the user to provide us his login credentials.


This OAuth2 microservice would be responsible for:
- Initial redirection to the service provider
- Callback from the service provider
- Persistence of access token that was received from  the service provider into the permanent backend (k8s secrets or Vault)
- Handling of negative authorization and error codes
- Creation or update of SPIAccessToken
- Successful redirection at the end

Also, this service provides an HTTP API to support manual upload of tokens for service providers that have the capability to manually generate individual tokens. Like GitHub's personal access tokens or Quay's robo-accounts.

## HTTP API Endpoints

- [POST /login](#post-login)
- [GET {sp_type}/authenticate](#get-sp_typeauthenticate)
- [GET /{sp_type}/callback](##get-sp_typecallback)
- [POST /token/{namespace}/{name}](#post-tokennamespacename)


### POST /login
This endpoint is used to authenticate `/{sp_type}/authenticate` method with Kubernetes (SSO) bearer token in the `Authorization` header.

This endpoint sets a session cookie that is required to be present when completing the OAuth flow in the `/{sp_type}/authenticate` and `/{sp_type}/callback` endpoints.

#### Response
 - 200 - authorization data successfully accepted.
 - 403 - provided authorization header is not valid. 
 - 
### GET /{sp_type}/authenticate
This method is used to initiate the OAuth flow. `{sp_type}` refers to the name of the service provider. 

This endpoint expects that k8s token provided by `/login` method. The token needs to enable creation of `SPIAccessTokenDataUpdate` objects in the target cluster.
The URL to this endpoint is generated by the SPI operator and can be read from the     status of the `SPIAccessTokenBinding` or `SPIAccessToken` objects.


#### Parameters
- state - The caller must supply the state query parameter which holds the OAuth flow state.
- k8s_token - the authorization token. It is HIGHLY DISCOURAGED to use this in a GET request. Use the Authorization header instead.
#### Headers
Authorization - optional, in the form `“Bearer <token>”`. Either this header, or `k8s_token` query parameter has to be provided.

#### Response
- 200 - returns an HTML page with meta http-equiv tag that redirects the caller to the corresponding service provider to perform the OAuth flow.
- 403 - if the authorization token is not correct or supplied

### GET /{sp_type}/callback
This is the endpoint to which the user is redirected from the service provider when the OAuth flow is completed. As such, this endpoint is not meant for direct consumption by any direct caller. Instead, the service provider redirects the clients to this endpoint upon completion of the OAuth flow.

#### Response
- 200 - an HTML page shown upon successful OR ERRONEOUS completion of the flow. The page shows a human-readable description of the result.

### POST /token/{namespace}/{name}
This endpoint is used to manually upload the token data for an existing SPIAccessToken object. This endpoint is authenticated using a Kubernetes (SSO) bearer token in the Authorization header.

#### Path Parameters
- namespace - the namespace of the SPIAccessToken object to update with the data
- name - the name of the SPIAccessToken object to update with the data

#### Headers
- Authorization - mandatory, in the form `“Bearer <token>”`.
#### Body
This endpoint accepts a JSON object with the following structure:

```json
{
        "access_token": "string value of the access token", 
        "username": "service provider username",
        "token_type": "the type of the token", // currently ignored
        "refresh_token": "string value of the refresh token", // currently ignored
        "expiry": 42 // the date when the token expires represented as timestamp, currently ignored         
}
```
#### Response
 - 204 - when the data is processed successfully
 - 403 - on authorization error


